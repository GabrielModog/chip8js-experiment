var $=512;var W=80;var q=64;var J=32;var w=128;var f=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];var A={49:1,50:2,51:3,52:12,81:4,87:5,69:6,82:13,65:7,83:8,68:9,70:14,90:10,88:0,67:11,86:15};class Y{constructor(F,x,L){this.memory=new Uint8Array(4096);this.registers=new Uint8Array(16);this.stack=new Array;this.pc=$;this.video=new Array(q*J).fill(0);this.sp=0;this.i=0;this.delayTimer=0;this.soundTimer=0;this.paused=false;this.draw_flag=false;this.keyboard=F;this.sound=x;this.display=L}loadFontsetInMemory(){for(let F=0;F<f.length;F++){this.memory[W+F]=f[F]}}cycle(){let F=this.memory[this.pc]<<8|this.memory[this.pc+1];this.instructions(F);if(this.delayTimer>0){this.delayTimer-=1}if(this.soundTimer>0){this.soundTimer-=1}if(this.soundTimer>0){this.sound.play()}else{this.sound.stop()}}sleep(){return new Promise((F)=>setTimeout(F,30))}increment_pc(){this.pc+=2}rand(){return Math.floor(Math.random()*255)}clearDisplay(){this.video.fill(0);this.draw_flag=false}reset(){this.clearDisplay();this.stack.fill(0);this.opcode=0;this.i=0;this.sp=0;this.pc=$;this.paused=false;this.delayTimer=0;this.soundTImer=0;for(let F=W;F<$;F++){this.memory[F]=0}}instructions(F){this.increment_pc();const x=(F&3840)>>8;const L=(F&240)>>4;const B=F&4095;const h=F&255;const X=8;const t=this.registers[x];const Z=this.registers[L];const E=F&15;switch(F&61440){case 0:{this.op_0(F)}break;case 4096:{this.op_1(B)}break;case 8192:{this.op_2(B)}break;case 12288:{this.op_3(x,h)}break;case 16384:{this.op_4(x,h)}break;case 20480:{this.op_5(x,L)}break;case 24576:{this.op_6(x,h)}break;case 28672:{this.op_7(x,h)}break;case 32768:{this.op_8(F,x,L)}break;case 36864:{this.op_9(x,L)}break;case 40960:{this.op_a(B)}break;case 45056:{this.op_b(B)}break;case 49152:{this.op_c(x,h)}break;case 53248:{this.op_d(t,Z,X,E,w)}break;case 57344:{this.op_e(F,x)}break;case 61440:{this.op_f(F,x)}break;default:console.error(`Unknow OPCODE: 0x${F.toString(16)}`);break}}}Y.prototype.op_0=function(F){switch(F){case 224:{this.clearDisplay()}break;case 238:{if(this.stack<0)return console.error("Stack Underflow");this.pc=this.stack.pop()}break}};Y.prototype.op_1=function(F){this.pc=F};Y.prototype.op_2=function(F){if(this.stack.length>15){console.error("Stack Overflow");return}this.stack.push(this.pc);this.pc=F};Y.prototype.op_3=function(F,x){if(this.registers[F]===x){this.increment_pc()}};Y.prototype.op_4=function(F,x){if(this.registers[F]!==x){this.increment_pc()}};Y.prototype.op_5=function(F,x){if(this.registers[F]===this.registers[x]){this.increment_pc()}};Y.prototype.op_6=function(F,x){this.registers[F]=x};Y.prototype.op_7=function(F,x){this.registers[F]+=x};Y.prototype.op_8=function(F,x,L){const B=F&15;switch(B){case 0:{this.registers[x]=this.registers[L]}break;case 1:{this.registers[x]|=this.registers[L]}break;case 2:{this.registers[x]&=this.registers[L]}break;case 3:{this.registers[x]^=this.registers[L]}break;case 4:{this.registers[15]=0;const h=this.registers[x]+this.registers[L];if(h>255){this.registers[15]=1}this.registers[x]=h}break;case 5:{this.registers[15]=0;if(this.registers[x]>this.registers[L]){this.registers[15]=1}this.registers[x]-=this.registers[L]}break;case 6:{this.registers[15]=this.registers[x]&1;this.registers[x]>>=1}break;case 7:{this.registers[15]=0;if(this.registers[L]>this.registers[x]){this.registers[15]=1}this.registers[x]=this.registers[L]-this.registers[x]}break;case 14:{this.registers[15]=(this.registers[x]&128)>>7;this.registers[x]<<=1}break}};Y.prototype.op_9=function(F,x){if(this.registers[F]!==this.registers[x]){this.increment_pc()}};Y.prototype.op_a=function(F){this.i=F};Y.prototype.op_b=function(F){this.pc=this.registers[0]+F};Y.prototype.op_c=function(F,x){const L=this.rand();this.registers[F]=L&x};Y.prototype.op_d=function(F,x,L,B,h){this.registers[15]=0;for(let X=0;X<B;X++){let t=this.memory[this.i+X];for(let Z=0;Z<L;Z++){if((t&h>>Z)!==0){const E=F+Z;const N=x+X;const m=E+N*q;if(this.video[m]===1){this.registers[15]=1}this.video[m]^=1}}}this.draw_flag=true};Y.prototype.op_e=function(F,x){const L=F&255;switch(L){case 158:{if(this.keyboard.isKeyPressed(this.registers[x])){this.increment_pc()}}break;case 161:{if(!this.keyboard.isKeyPressed(this.registers[x])){this.increment_pc()}}break}};Y.prototype.op_f=function(F,x){const L=F&255;switch(L){case 7:{this.registers[x]=this.delayTimer}break;case 10:{this.paused=true;this.keyboard.nextKeyCallback=(B)=>{this.registers[x]=B;this.paused=false}}break;case 21:{this.delayTimer=this.registers[x]}break;case 24:{this.soundTimer=this.registers[x]}break;case 30:{this.i+=this.registers[x]}break;case 41:{this.i=this.registers[x]*5}break;case 51:{let B=this.registers[x];this.memory[this.i]=Math.floor(B/100);this.memory[this.i+1]=Math.floor(B%100/10);this.memory[this.i+2]=Math.floor(B%10)}break;case 85:{for(let B=0;B<=x;B++){this.memory[this.i+B]=this.registers[B]}}break;case 101:{for(let B=0;B<=x;B++){this.registers[B]=this.memory[this.i+B]}}break;default:console.error(`Unknow OPCODE: 0x${F.toString(16)}`);break}};class K{cpu;constructor(F,x,L){this.keyboard=F;this.sound=x;this.display=L;this.cpu=new Y(this.keyboard,this.sound,this.display);this.currentRom=null;this.elapsed=0;this.lastTimestamp=performance.now();this.fixedFPS=1000/600;this.frameCount=0;this.tick=this.tick.bind(this);this.cpu.loadFontsetInMemory()}loadRomBufferInMemory(F){for(let x=0;x<F.length;x++){this.cpu.memory[$+x]=F[x]}}async fetchRom(F){this.currentRom=F;try{const x=await fetch(`roms/${F}.ch8`);const L=await x.arrayBuffer();const B=new Uint8Array(L);this.loadRomBufferInMemory(B)}catch(x){console.error(x)}}init(F){this.clear();this.fetchRom(F)}clear(){this.cpu.reset();this.cpu=new Y(this.keyboard,this.sound,this.display)}onScaleChange(F){this.cpu.display.scale=F;this.cpu.display.pixelSize=F;this.cpu.display.canvas.width=q*F;this.cpu.display.canvas.height=J*F}togglePause(){const F=this.cpu.paused;this.cpu.paused=!F}drawInfo(){appTimerInterval.innerText=Math.round(1000/this.fixedFPS)+" mhz";appTimerElapsed.innerText=this.frameCount;appTimerDelay.innerText=this.cpu.delayTimer;appTimerSound.innerText=this.cpu.soundTimer;memreg.innerText=this.cpu.registers.join(" | ")}async tick(F){const x=F-this.lastTimestamp;this.lastTimestamp=F;if(!this.elapsed){this.elapsed=0}this.elapsed+=x;this.frameCount=0;while(this.elapsed>=this.fixedFPS&&this.frameCount<10){this.elapsed-=this.fixedFPS;this.frameCount++;if(!this.cpu.paused){this.cpu.cycle()}}this.drawInfo();if(this.cpu.draw_flag){this.display.render(this.cpu.video);this.cpu.draw_flag=false}await this.cpu.sleep();requestAnimationFrame(this.tick)}}class M{constructor(F=10,x=10){this.canvas=document.getElementById("app");this.ctx=this.canvas.getContext("2d");this.scale=F;this.pixelSize=x;this.canvas.width=q*this.scale;this.canvas.height=J*this.scale}render(F){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let x=0;x<q;x++){for(let L=0;L<J;L++){const B=F[x+L*q];if(B){this.ctx.fillStyle="#212f3d";this.ctx.fillRect(x*this.scale,L*this.scale,this.pixelSize,this.pixelSize)}}}}}class Q{keysPressed;nextKeyCallback;constructor(F){this.keysMap=F;this.keysPressed={};this.nextKeyCallback=null;this.init()}init(){window.addEventListener("keydown",this.onKeyDown.bind(this),false);window.addEventListener("keyup",this.onKeyRelease.bind(this),false)}}Q.prototype.isKeyPressed=function(F){return this.keysPressed[F]};Q.prototype.onKeyDown=function(F){const x=F?.keyCode;const L=this.keysMap[x];if(!L)return;this.keysPressed[L]=true;if(this.nextKeyCallback&&L){this.nextKeyCallback(L);this.nextKeyCallback=null}};Q.prototype.onKeyRelease=function(F){const x=F?.keyCode;const L=this.keysMap[x];this.keysPressed[L]=false};class z{audioContext;gain;destination;constructor(){this.audioContext=new window.AudioContext;this.gain=this.audioContext.createGain();this.destination=this.audioContext.destination;this.gain.connect(this.destination)}}z.prototype.play=function(){if(this.audioContext&&!this.oscillator){this.oscillator=this.audioContext.createOscillator();this.oscillator.frequency.setValueAtTime(440,this.audioContext.currentTime);this.oscillator.type="square";this.oscillator.connect(this.gain);this.oscillator.start()}};z.prototype.stop=function(){if(this.oscillator){this.oscillator.stop();this.oscillator.disconnect();this.oscillator=null}};var j=new URLSearchParams(document.location.search);var V=document.getElementById("scale");var H=document.getElementById("roms");var O=new Q(A);var u=new z;var _=new M;var G=new K(O,u,_);var g="blitz";if(j.has("rom")){g=j.get("rom");H.value=g}G.init(g);document.addEventListener("DOMContentLoaded",()=>{G.tick()});V.addEventListener("change",(F)=>{G.onScaleChange(parseInt(F.target.value))});H.addEventListener("change",(F)=>{G.clear();j.set("rom",F.target.value);document.location.search=j.toString();G.init(F.target.value)});
